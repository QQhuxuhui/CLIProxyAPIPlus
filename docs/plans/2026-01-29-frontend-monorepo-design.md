# 前端 Monorepo 架构实施计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 将前端源码集成到当前仓库，实现前后端统一管理，并添加 kiro 认证入口。

**Architecture:** 采用 Monorepo 结构，前端源码放在 `web/` 目录，使用 Vite 构建单文件 HTML，通过 Go embed 嵌入到后端二进制中。使用 Makefile 统一管理前后端构建流程。

**Tech Stack:** Vue 3 + TypeScript + Vite (前端), Go + Gin (后端), Makefile (构建)

---

## Task 1: 克隆前端源码

**Files:**
- Create: `web/` (整个目录)
- Delete: `web/.git/`, `web/.github/`, `web/LICENSE`, `web/README.md`, `web/README_CN.md`

**Step 1: 克隆前端仓库**

```bash
cd /usr/src/workspace/github/QQhuxuhui/CLIProxyAPIPlus
git clone https://github.com/router-for-me/Cli-Proxy-API-Management-Center.git web
```

Expected: 成功克隆仓库到 `web/` 目录

**Step 2: 移除不需要的文件**

```bash
rm -rf web/.git web/.github web/LICENSE web/README.md web/README_CN.md web/logo.jpg
```

Expected: 命令成功执行，无输出

**Step 3: 验证目录结构**

```bash
ls -la web/
```

Expected: 显示 `src/`, `package.json`, `vite.config.ts`, `index.html` 等文件

**Step 4: Commit**

```bash
git add web/
git commit -m "feat: add frontend source code for monorepo structure"
```

---

## Task 2: 配置 Vite 构建

**Files:**
- Modify: `web/vite.config.ts`
- Modify: `web/package.json`

**Step 1: 读取当前 vite.config.ts**

```bash
cat web/vite.config.ts
```

Expected: 显示当前 Vite 配置

**Step 2: 修改 vite.config.ts 添加代理和单文件输出**

修改 `web/vite.config.ts`，添加以下配置：

```typescript
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { viteSingleFile } from 'vite-plugin-singlefile'

export default defineConfig({
  plugins: [
    vue(),
    viteSingleFile()
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    proxy: {
      '/v0/management': 'http://localhost:8080',
      '/v1': 'http://localhost:8080',
      '/anthropic': 'http://localhost:8080',
      '/codex': 'http://localhost:8080',
      '/google': 'http://localhost:8080',
      '/kiro': 'http://localhost:8080'
    }
  },
  build: {
    outDir: 'dist',
    assetsInlineLimit: 100000000,
    chunkSizeWarningLimit: 100000000,
    cssCodeSplit: false,
    rollupOptions: {
      output: {
        inlineDynamicImports: true
      }
    }
  }
})
```

**Step 3: 安装 vite-plugin-singlefile**

```bash
cd web && npm install vite-plugin-singlefile --save-dev
```

Expected: 成功安装依赖

**Step 4: 修改 package.json 添加构建脚本**

在 `web/package.json` 的 `scripts` 中确保有：

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc -b && vite build",
    "preview": "vite preview"
  }
}
```

**Step 5: 验证构建**

```bash
cd web && npm install && npm run build
```

Expected: 构建成功，生成 `web/dist/index.html`

**Step 6: Commit**

```bash
git add web/vite.config.ts web/package.json web/package-lock.json
git commit -m "feat: configure vite for single-file HTML output with API proxy"
```

---

## Task 3: 创建 Makefile

**Files:**
- Create: `Makefile`

**Step 1: 创建 Makefile**

创建 `Makefile`：

```makefile
.PHONY: build build-web build-go dev dev-web dev-go clean install-web

# 默认目标
all: build

# 安装前端依赖
install-web:
	cd web && npm install

# 构建前端
build-web: install-web
	cd web && npm run build
	mkdir -p internal/managementasset/static
	cp web/dist/index.html internal/managementasset/static/management.html
	@echo "Frontend built successfully"

# 构建后端
build-go:
	go build -o bin/server ./cmd/server
	@echo "Backend built successfully"

# 构建全部（先前端后后端）
build: build-web build-go
	@echo "Full build completed"

# 前端开发模式
dev-web:
	cd web && npm run dev

# 后端开发模式
dev-go:
	go run ./cmd/server

# 清理
clean:
	rm -rf bin/
	rm -rf web/dist/
	rm -rf web/node_modules/
	rm -f internal/managementasset/static/management.html
	@echo "Cleaned up build artifacts"

# 帮助
help:
	@echo "Available targets:"
	@echo "  make build      - Build frontend and backend"
	@echo "  make build-web  - Build frontend only"
	@echo "  make build-go   - Build backend only"
	@echo "  make dev-web    - Start frontend dev server"
	@echo "  make dev-go     - Start backend dev server"
	@echo "  make clean      - Clean build artifacts"
	@echo "  make install-web - Install frontend dependencies"
```

**Step 2: 验证 Makefile**

```bash
make help
```

Expected: 显示帮助信息

**Step 3: Commit**

```bash
git add Makefile
git commit -m "feat: add Makefile for unified build management"
```

---

## Task 4: 更新 .gitignore

**Files:**
- Modify: `.gitignore`

**Step 1: 读取当前 .gitignore**

```bash
cat .gitignore
```

Expected: 显示当前 .gitignore 内容

**Step 2: 添加前端相关忽略规则**

在 `.gitignore` 末尾添加：

```gitignore

# Frontend
web/node_modules/
web/dist/

# Build artifacts (generated by frontend build)
internal/managementasset/static/management.html
```

**Step 3: 移除之前下载的 management.html**

```bash
rm -f internal/managementasset/static/management.html
```

**Step 4: Commit**

```bash
git add .gitignore
git commit -m "chore: update gitignore for frontend monorepo"
```

---

## Task 5: 添加 kiro 认证入口

**Files:**
- Modify: `web/src/views/` (认证相关视图)
- Modify: `web/src/api/` (API 调用)

**Step 1: 搜索现有认证入口实现**

```bash
grep -r "anthropic-auth-url\|codex-auth-url\|gemini-cli-auth-url" web/src/ --include="*.vue" --include="*.ts" -l
```

Expected: 列出包含其他认证入口的文件

**Step 2: 分析现有认证入口代码结构**

读取找到的文件，理解现有认证入口的实现模式

**Step 3: 添加 kiro 认证 API 调用**

在 API 模块中添加 kiro 相关调用（参考现有 anthropic/codex 实现）

**Step 4: 添加 kiro 认证 UI 组件**

在认证视图中添加 kiro 认证按钮（参考现有 anthropic/codex 实现）：
- AWS Builder ID 认证入口
- Google 社交登录入口
- GitHub 社交登录入口

**Step 5: 验证前端构建**

```bash
cd web && npm run build
```

Expected: 构建成功

**Step 6: Commit**

```bash
git add web/src/
git commit -m "feat: add kiro authentication entry in frontend"
```

---

## Task 6: 验证构建和集成

**Files:**
- None (验证步骤)

**Step 1: 完整构建**

```bash
make clean && make build
```

Expected: 前端和后端都构建成功

**Step 2: 验证 Go embed**

```bash
go build ./internal/managementasset/...
```

Expected: 编译成功

**Step 3: 启动服务器测试**

```bash
./bin/server --config config.yaml
```

Expected: 服务器启动成功

**Step 4: 验证管理页面**

```bash
curl -s http://localhost:8080/management.html | head -20
```

Expected: 返回 HTML 内容

**Step 5: 最终 Commit**

```bash
git add .
git commit -m "feat: complete frontend monorepo integration with kiro auth"
```

---

## 关键设计决策

1. **Monorepo 结构** - 所有代码在一个仓库，统一版本控制
2. **Go embed** - 前端构建产物嵌入到 Go 二进制中
3. **Vite 代理** - 开发时前端通过代理访问后端 API
4. **vite-plugin-singlefile** - 将所有资源内联到单个 HTML 文件
5. **Makefile** - 简化构建命令，统一前后端构建流程

## 开发工作流

```bash
# 前端开发（热重载）
make dev-web    # 启动 Vite 开发服务器，端口 5173

# 后端开发（另一个终端）
make dev-go     # 启动 Go 服务器，端口 8080

# 完整构建
make build      # 构建前端 + 后端

# 清理
make clean      # 清理所有构建产物
```
